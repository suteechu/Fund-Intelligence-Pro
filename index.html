<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fund Intelligence Pro - Premium Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@300;400;500;700&display=swap');
        
        :root { 
            --primary: #4f46e5; 
            --success: #10b981; 
            --danger: #f43f5e;
            --surface: #ffffff;
        }

        body { 
            font-family: 'Inter', 'Sarabun', sans-serif; 
            background: #f8fafc; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .stat-card {
            background: var(--surface);
            @apply p-5 rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-300;
        }
        
        .stat-card:hover {
            @apply -translate-y-1 shadow-xl shadow-indigo-100/30;
            border-color: rgba(79, 70, 229, 0.2);
        }

        .chart-container { position: relative; height: 320px; width: 100%; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .animate-fade-up {
            animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Heatmap Styles */
        .heatmap-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem;
        }

        .heatmap-grid {
            min-width: 800px; /* Ensure minimum width to prevent squashing */
        }

        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 800;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 38px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .heatmap-cell:hover {
            transform: scale(1.15);
            z-index: 20;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .goal-indicator {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
        }

        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tab-btn.active {
            @apply bg-indigo-600 text-white shadow-md;
        }
        .tab-btn:not(.active) {
            @apply text-slate-500 hover:bg-slate-100;
        }

        /* Fixed Table Header */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .table-sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: rgba(248, 250, 252, 0.95);
            backdrop-filter: blur(4px);
        }

        /* Projection Cards */
        .proj-card {
            transition: all 0.3s ease;
        }
        .proj-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="min-h-screen pb-12 selection:bg-indigo-100 selection:text-indigo-900">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-nav no-print">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shrink-0">
                    <i data-lucide="bar-chart-big" class="w-5 h-5"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-base font-bold text-slate-900 leading-none">Fund Intelligence</h1>
                    <p class="text-[9px] text-indigo-500 font-bold uppercase tracking-[0.1em] mt-1">Institutional Dashboard</p>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div id="navTabs" class="hidden flex bg-slate-100 p-1 rounded-2xl gap-1 overflow-x-auto max-w-[200px] sm:max-w-none no-scrollbar">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active px-4 py-1.5 rounded-xl text-xs font-bold transition-all whitespace-nowrap">ภาพรวม</button>
                <button onclick="switchTab('heatmap')" id="tab-heatmap" class="tab-btn px-4 py-1.5 rounded-xl text-xs font-bold transition-all whitespace-nowrap">วิเคราะห์รายเดือน</button>
                <button onclick="switchTab('simulation')" id="tab-simulation" class="tab-btn px-4 py-1.5 rounded-xl text-xs font-bold transition-all whitespace-nowrap text-indigo-600">
                    <i data-lucide="calculator" class="w-3 h-3 inline mr-1 mb-0.5"></i>จำลองอนาคต
                </button>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="togglePasteModal(true)" class="bg-indigo-600 text-white px-3 sm:px-5 py-2.5 rounded-2xl text-xs font-bold hover:bg-indigo-700 transition-all active:scale-95 shadow-lg shadow-indigo-100 flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">วางข้อมูล</span>
                    <span class="sm:hidden">Add</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Empty State -->
        <div id="emptyState" class="py-12 sm:py-24 text-center animate-fade-up">
            <div class="max-w-md mx-auto px-4">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="layout-dashboard" class="w-10 h-10"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">เริ่มวิเคราะห์พอร์ตของคุณ</h2>
                <p class="text-slate-500 text-sm mb-10 leading-relaxed">คัดลอกตารางจาก Excel หรือระบบพอร์ทัลมาวางเพื่อดูแนวโน้มการเติบโตและสุขภาพการลงทุนได้ทันที</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="togglePasteModal(true)" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-3">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                        วางข้อมูลเพื่อเริ่มต้น
                    </button>
                    <button onclick="loadSampleData()" class="bg-white border border-slate-200 text-slate-600 px-8 py-4 rounded-2xl font-bold hover:bg-slate-50 transition-all">
                        ดูข้อมูลตัวอย่าง
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-6 animate-fade-up">
            
            <!-- Filter Bar (Global for both tabs) -->
            <div id="filterBar" class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                <div class="flex items-center gap-2 bg-white p-1 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto custom-scrollbar w-full lg:w-auto max-w-full">
                    <button onclick="setFilter('all')" id="filter-all" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-indigo-600 text-white shrink-0">ทั้งหมด</button>
                    <div id="yearFilters" class="flex gap-1"></div>
                </div>
                <div class="bg-white px-4 py-2 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4 w-full lg:w-auto justify-between">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="target" class="w-4 h-4"></i>
                        <span class="text-[10px] font-bold uppercase tracking-tighter">เป้าหมาย (฿)</span>
                    </div>
                    <input type="number" id="goalInput" value="1000000" onchange="updateUI()" class="w-32 text-right font-bold focus:ring-0 border-none p-0 text-indigo-600 bg-transparent" />
                </div>
            </div>

            <!-- VIEW: OVERVIEW -->
            <div id="view-overview" class="space-y-6">
                <!-- Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                            <span id="totalReturnBadge" class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500"></span>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">มูลค่ารวม</p>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900 truncate" id="totalValue">฿0</h3>
                    </div>
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <div class="p-2 bg-emerald-50 text-emerald-600 rounded-xl"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">กำไรสะสม</p>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900 truncate" id="totalProfit">฿0</h3>
                    </div>
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <div class="p-2 bg-amber-50 text-amber-600 rounded-xl"><i data-lucide="flag" class="w-4 h-4"></i></div>
                            <span id="goalProgressPct" class="text-[10px] font-bold text-amber-600">0%</span>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ความคืบหน้า</p>
                        <div class="mt-2.5 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                            <div id="goalProgressBar" class="h-full goal-indicator transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <div class="p-2 bg-slate-50 text-slate-600 rounded-xl"><i data-lucide="calendar-check" class="w-4 h-4"></i></div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">งวดลงทุน</p>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900" id="dataCountVal">0 งวด</h3>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                        <h4 class="text-sm font-bold mb-6 flex items-center gap-2"><i data-lucide="area-chart" class="w-4 h-4 text-indigo-600"></i> แนวโน้มการเติบโต</h4>
                        <div class="chart-container"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col items-center">
                        <h4 class="text-sm font-bold mb-6 w-full"><i data-lucide="pie-chart" class="w-4 h-4 text-indigo-600 inline mr-1"></i> สัดส่วนเงินทุน</h4>
                        <div class="relative w-full max-w-[200px] aspect-square my-auto">
                            <canvas id="pieChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-[8px] text-slate-400 font-bold uppercase tracking-wider">Total</span>
                                <span id="pieCenterVal" class="text-sm font-bold text-slate-900">฿0</span>
                            </div>
                        </div>
                        <div class="w-full grid grid-cols-2 gap-2 mt-6">
                            <div class="p-3 bg-indigo-50/50 rounded-2xl text-center">
                                <p class="text-[9px] font-bold text-indigo-600 uppercase">พนง.</p>
                                <p id="empPct" class="text-xs font-bold">0%</p>
                            </div>
                            <div class="p-3 bg-rose-50/50 rounded-2xl text-center">
                                <p class="text-[9px] font-bold text-rose-600 uppercase">นจ.</p>
                                <p id="employerPct" class="text-xs font-bold">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-slate-50 flex items-center justify-between shrink-0">
                        <h4 class="text-sm font-bold text-slate-900">ประวัติรายการรายงวด</h4>
                        <span id="dataCount" class="text-[10px] bg-slate-100 px-3 py-1 rounded-xl font-bold text-slate-500">0 งวด</span>
                    </div>
                    <div class="table-container custom-scrollbar w-full">
                        <table class="w-full text-xs text-left border-collapse min-w-[600px]">
                            <thead class="table-sticky-header font-bold text-slate-500 uppercase tracking-tight">
                                <tr>
                                    <th class="px-6 py-4">งวดวันที่</th>
                                    <th class="px-4 py-4 text-right">เงินต้นสะสม</th>
                                    <th class="px-4 py-4 text-right">กำไรสะสม</th>
                                    <th class="px-4 py-4 text-right">การเติบโต</th>
                                    <th class="px-6 py-4 text-right">มูลค่าสุทธิ</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: HEATMAP (Separate Page) -->
            <div id="view-heatmap" class="hidden space-y-6">
                <div class="bg-white p-6 sm:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
                        <div>
                            <h4 class="text-base font-bold text-slate-900 flex items-center gap-2">
                                <i data-lucide="grid" class="w-5 h-5 text-indigo-600"></i>
                                ผลตอบแทนกำไรรายเดือน
                            </h4>
                            <p class="text-xs text-slate-400 mt-1 uppercase font-bold tracking-tight">Monthly Profit Heatmap</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-4 text-[10px] font-bold text-slate-400 bg-slate-50 px-4 py-2 rounded-2xl">
                             <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-sm bg-rose-500 shadow-sm"></span> ขาดทุน</div>
                             <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-sm bg-emerald-500 shadow-sm"></span> กำไร</div>
                             <div class="text-indigo-600">หน่วย: 1,000 บาท (K)</div>
                        </div>
                    </div>
                    
                    <div class="heatmap-wrapper custom-scrollbar">
                        <div id="heatmapContainer" class="heatmap-grid space-y-3 pb-6"></div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100 flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-indigo-600 mt-0.5 shrink-0"></i>
                        <p class="text-xs text-indigo-900 leading-relaxed font-medium">
                            <strong class="block mb-1">วิธีอ่านข้อมูล:</strong>
                            ตารางนี้แสดง "กำไร/ขาดทุนที่เพิ่มขึ้นจริง" ในแต่ละงวดเดือน โดยคำนวณจากส่วนต่างของกำไรสะสมปัจจุบันกับงวดก่อนหน้า เพื่อให้คุณเห็นศักยภาพการทำเงินของกองทุนในแต่ละเดือนได้อย่างชัดเจน
                        </p>
                    </div>
                </div>
            </div>

            <!-- VIEW: SIMULATION (New) -->
            <div id="view-simulation" class="hidden space-y-6">
                <!-- Inputs Panel -->
                <div class="bg-white p-6 sm:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <div class="flex flex-col sm:flex-row gap-8">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-slate-900 mb-2 flex items-center gap-2">
                                <i data-lucide="settings-2" class="w-5 h-5 text-indigo-600"></i>
                                ตั้งค่าสมมติฐาน (Assumptions)
                            </h4>
                            <p class="text-xs text-slate-500 mb-6">ปรับเปลี่ยนค่าด้านล่างเพื่อดูผลลัพธ์ในอนาคต</p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">ผลตอบแทนคาดหวัง (% ต่อปี)</label>
                                    <div class="flex items-center bg-slate-50 rounded-xl px-4 py-3 border border-slate-200">
                                        <input type="number" id="simRate" value="5" step="0.5" onchange="renderSimulation()" class="bg-transparent border-none w-full font-bold text-slate-900 focus:ring-0 p-0" />
                                        <span class="text-sm font-bold text-slate-400">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">เงินสมทบต่อเดือน (บาท)</label>
                                    <div class="flex items-center bg-slate-50 rounded-xl px-4 py-3 border border-slate-200">
                                        <input type="number" id="simMonthly" value="0" step="100" onchange="renderSimulation()" class="bg-transparent border-none w-full font-bold text-slate-900 focus:ring-0 p-0" />
                                        <span class="text-sm font-bold text-slate-400">฿</span>
                                    </div>
                                    <p class="text-[10px] text-indigo-500 mt-1.5 font-medium">*ประเมินจากงวดล่าสุด (พนง.+นายจ้าง)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="hidden sm:block w-px bg-slate-100"></div>

                        <div class="flex-1 flex flex-col justify-center">
                            <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
                                <h5 class="font-bold text-indigo-900 text-sm mb-2 flex items-center gap-2">
                                    <i data-lucide="lightbulb" class="w-4 h-4"></i> คำแนะนำ
                                </h5>
                                <p class="text-xs text-indigo-800 leading-relaxed">
                                    ยอดเงินที่คำนวณได้เป็น <strong>"ยอดรวมทั้งกองทุน"</strong> (100%) หากท่านลาออก ยอดที่ได้รับจริงอาจน้อยกว่านี้ ขึ้นอยู่กับ <strong>"อายุงาน"</strong> และเงื่อนไขการจ่ายเงินสมทบส่วนของนายจ้าง (Vesting Rule) ตามข้อบังคับกองทุนของท่าน
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- 3 Years -->
                    <div class="proj-card bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="text-6xl font-black text-indigo-900">3Y</span>
                        </div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">อีก 3 ปีข้างหน้า</p>
                        <h3 class="text-2xl font-black text-indigo-600 mb-2" id="val3y">฿0</h3>
                        <div class="flex items-center gap-2 text-xs font-bold text-emerald-600 bg-emerald-50 w-fit px-3 py-1 rounded-lg">
                            <i data-lucide="trending-up" class="w-3 h-3"></i>
                            <span id="gain3y">+฿0</span>
                        </div>
                    </div>

                    <!-- 5 Years -->
                    <div class="proj-card bg-indigo-600 p-6 rounded-[2rem] shadow-lg shadow-indigo-200 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="text-6xl font-black text-white">5Y</span>
                        </div>
                        <p class="text-xs font-bold text-indigo-200 uppercase tracking-widest mb-4">อีก 5 ปีข้างหน้า</p>
                        <h3 class="text-2xl font-black text-white mb-2" id="val5y">฿0</h3>
                        <div class="flex items-center gap-2 text-xs font-bold text-white bg-white/20 w-fit px-3 py-1 rounded-lg backdrop-blur-sm">
                            <i data-lucide="trending-up" class="w-3 h-3"></i>
                            <span id="gain5y">+฿0</span>
                        </div>
                    </div>

                    <!-- 10 Years -->
                    <div class="proj-card bg-slate-900 p-6 rounded-[2rem] shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="text-6xl font-black text-white">10Y</span>
                        </div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">อีก 10 ปีข้างหน้า</p>
                        <h3 class="text-2xl font-black text-white mb-2" id="val10y">฿0</h3>
                        <div class="flex items-center gap-2 text-xs font-bold text-emerald-400 bg-emerald-400/10 w-fit px-3 py-1 rounded-lg">
                            <i data-lucide="trending-up" class="w-3 h-3"></i>
                            <span id="gain10y">+฿0</span>
                        </div>
                    </div>
                </div>

                <!-- Projection Chart -->
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <h4 class="text-sm font-bold mb-6 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-indigo-600"></i> เปรียบเทียบยอดเงินในอนาคต</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="simChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal: Paste Data -->
    <div id="pasteModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-fade-up">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="clipboard-list" class="w-5 h-5"></i></div>
                    <h3 class="font-bold text-slate-900">วางข้อมูลตารางกองทุน</h3>
                </div>
                <button onclick="togglePasteModal(false)" class="p-2 hover:bg-slate-100 rounded-xl"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <textarea id="pasteArea" class="w-full h-64 sm:h-80 p-4 rounded-[1.5rem] bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 outline-none font-mono text-[10px] resize-none custom-scrollbar" placeholder="คัดลอกจาก Excel แล้ววางที่นี่..."></textarea>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="smartProcess()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition-all">เริ่มวิเคราะห์ข้อมูล</button>
                    <button onclick="togglePasteModal(false)" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold transition-all hover:bg-slate-200">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let fullData = [], filteredData = [], mainChart, pieChart, simChart;
        let currentTab = 'overview';

        const switchTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-indigo-600'); 
                if(!btn.classList.contains('active')) btn.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-slate-500');
            if(tab === 'simulation') activeBtn.classList.add('text-white'); // Fix text color for active simulation tab

            document.getElementById('view-overview').classList.add('hidden');
            document.getElementById('view-heatmap').classList.add('hidden');
            document.getElementById('view-simulation').classList.add('hidden');
            document.getElementById('filterBar').classList.remove('hidden');

            if(tab === 'overview') {
                document.getElementById('view-overview').classList.remove('hidden');
            } else if (tab === 'heatmap') {
                document.getElementById('view-heatmap').classList.remove('hidden');
                renderHeatmap(); 
            } else if (tab === 'simulation') {
                document.getElementById('view-simulation').classList.remove('hidden');
                document.getElementById('filterBar').classList.add('hidden'); // Hide year filter for simulation
                renderSimulation();
            }
        };

        const togglePasteModal = s => {
            const m = document.getElementById('pasteModal');
            if(m) m.classList.toggle('hidden', !s);
            if(s) { const a = document.getElementById('pasteArea'); if(a){ a.value=''; a.focus(); } }
        };

        const parseNum = v => v ? parseFloat(v.replace(/,/g, '')) || 0 : 0;

        const getDateValue = s => {
            if (!s) return new Date();
            const p = s.split(/[./-]/);
            if(p.length === 3) { 
                let y = parseInt(p[2]); 
                if (y < 100) y += 2000;
                if (y > 2400) y -= 543; 
                return new Date(y, parseInt(p[1])-1, parseInt(p[0])); 
            }
            return new Date(s);
        };

        const loadSampleData = () => {
            const sample = `31.12.2025\t669,584.60\t113,545.81\t53,941.10\t98,705.06\t1,420,776.57
30.11.2025\t664,058.60\t110,960.85\t53,520.30\t96,599.65\t1,406,139.40
31.10.2025\t658,532.60\t112,183.99\t53,099.50\t97,596.29\t1,398,412.38
30.09.2025\t653,006.60\t106,883.68\t52,678.70\t93,276.27\t1,378,845.25
31.08.2025\t647,480.60\t94,979.20\t52,157.90\t83,576.93\t1,347,294.63
31.07.2025\t641,954.60\t86,240.75\t51,837.10\t76,457.56\t1,321,490.01
31.12.2024\t603,272.60\t60,277.89\t48,891.50\t55,299.57\t1,204,741.56
30.11.2024\t597,911.60\t66,450.20\t48,602.70\t60,337.61\t1,206,302.11`;
            document.getElementById('pasteArea').value = sample;
            smartProcess();
        };

        const smartProcess = () => {
            const area = document.getElementById('pasteArea');
            if(!area) return;
            const text = area.value.trim();
            if(!text) return;
            
            const res = [];
            text.split('\n').forEach(line => {
                const dateMatch = line.match(/(\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})/);
                if(dateMatch) {
                    const dStr = dateMatch[1];
                    const remainingStr = line.substring(line.indexOf(dStr) + dStr.length);
                    const nums = remainingStr.match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/g) || [];
                    
                    if(nums.length >= 5) {
                        res.push({ 
                            date: dStr, 
                            empAccum: parseNum(nums[0]), 
                            empReturn: parseNum(nums[1]), 
                            employerAccum: parseNum(nums[2]), 
                            employerReturn: parseNum(nums[3]), 
                            total: parseNum(nums[4]), 
                            sortDate: getDateValue(dStr) 
                        });
                    }
                }
            });

            if(!res.length) {
                alert("ไม่พบข้อมูลรูปแบบที่ถูกต้อง กรุณาตรวจสอบตารางของคุณอีกครั้ง\n(ต้องมีวันที่ และตัวเลข 5 คอลัมน์)");
                return;
            }

            fullData = res.sort((a,b) => a.sortDate - b.sortDate);
            genYearFilters();
            setFilter('all');
            
            // Auto-estimate monthly contribution for simulation
            if(fullData.length >= 2) {
                const last = fullData[fullData.length-1];
                const prev = fullData[fullData.length-2];
                // Estimate based on accumulation change (excluding return change, just principal)
                const empCont = Math.max(0, last.empAccum - prev.empAccum);
                const employerCont = Math.max(0, last.employerAccum - prev.employerAccum);
                const estimatedMonthly = empCont + employerCont;
                document.getElementById('simMonthly').value = estimatedMonthly > 0 ? estimatedMonthly : 1000;
            }

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('navTabs').classList.remove('hidden');
            togglePasteModal(false);
        };

        const genYearFilters = () => {
            const cont = document.getElementById('yearFilters'); 
            if(!cont) return;
            cont.innerHTML = '';
            const years = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort();
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.className = "px-4 py-2 rounded-xl text-xs font-bold transition-all text-slate-500 hover:bg-slate-50 shrink-0";
                btn.textContent = y; 
                btn.id = `filter-${y}`; 
                btn.onclick = () => setFilter(y);
                cont.appendChild(btn);
            });
        };

        const setFilter = y => {
            document.querySelectorAll('#yearFilters button, #filter-all').forEach(b => { 
                b.classList.remove('bg-indigo-600', 'text-white'); 
                b.classList.add('text-slate-500'); 
            });
            const act = document.getElementById(y === 'all' ? 'filter-all' : `filter-${y}`);
            if(act) { act.classList.add('bg-indigo-600', 'text-white'); act.classList.remove('text-slate-500'); }
            
            if (y === 'all') {
                filteredData = fullData;
            } else {
                filteredData = fullData.filter(d => d.sortDate.getFullYear() === parseInt(y));
            }
            updateUI();
        };

        const updateUI = () => {
            if(!filteredData.length) return;
            const last = filteredData[filteredData.length-1];
            const nf = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n);
            
            document.getElementById('totalValue').textContent = nf(last.total);
            const profit = last.empReturn + last.employerReturn;
            document.getElementById('totalProfit').textContent = nf(profit);
            const inv = Math.max(last.empAccum + last.employerAccum, 1);
            document.getElementById('dataCountVal').textContent = `${filteredData.length} งวด`;

            const goal = parseFloat(document.getElementById('goalInput').value) || 1;
            const progress = (last.total / goal) * 100;
            document.getElementById('goalProgressPct').textContent = progress.toFixed(1) + '%';
            document.getElementById('goalProgressBar').style.width = Math.min(progress, 100) + '%';
            
            const pct = (profit / inv) * 100;
            const rb = document.getElementById('totalReturnBadge');
            rb.innerHTML = `<i data-lucide="${pct>=0?'trending-up':'trending-down'}" class="w-3 h-3"></i> ${pct>=0?'+':''}${pct.toFixed(2)}%`;
            rb.className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${pct>=0?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'}`;
            
            document.getElementById('pieCenterVal').textContent = nf(last.total).replace('฿', '');
            const ePctValue = ((last.empAccum+last.empReturn)/last.total)*100;
            document.getElementById('empPct').textContent = ePctValue.toFixed(0) + '%';
            document.getElementById('employerPct').textContent = (100-ePctValue).toFixed(0) + '%';
            document.getElementById('dataCount').textContent = `${filteredData.length} งวด`;

            renderCharts(last); 
            renderHeatmap(); 
            renderTable(); 
            lucide.createIcons();
        };

        const renderCharts = (last) => {
            const ctxL = document.getElementById('mainChart').getContext('2d');
            if(mainChart) mainChart.destroy();
            const g = ctxL.createLinearGradient(0, 0, 0, 300);
            g.addColorStop(0, 'rgba(79, 70, 229, 0.2)');
            g.addColorStop(1, 'rgba(79, 70, 229, 0)');

            mainChart = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: filteredData.map(d=>d.date),
                    datasets: [
                        { label: 'สินทรัพย์รวม', data: filteredData.map(d=>d.total), borderColor: '#4f46e5', borderWidth: 3, fill: true, backgroundColor: g, tension: 0.4, pointRadius: 0, pointHitRadius: 10 },
                        { label: 'กำไรสะสม', data: filteredData.map(d=>d.empReturn+d.employerReturn), borderColor: '#10b981', borderWidth: 2, borderDash: [5,5], tension: 0.4, pointRadius: 0, pointHitRadius: 10 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Sarabun' }, titleFont: { family: 'Sarabun' } } },
                    scales: { y: { ticks: { font: { size: 10 }, callback: function(value) { return value/1000 + 'k'; } }, grid: { borderDash: [4,4] } }, x: { ticks: { font: { size: 10 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 6 }, grid: { display: false } } }
                }
            });
            
            const ctxP = document.getElementById('pieChart').getContext('2d');
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctxP, {
                type: 'doughnut',
                data: { 
                    labels: ['พนักงาน', 'นายจ้าง'], 
                    datasets: [{ 
                        data: [last.empAccum+last.empReturn, last.employerAccum+last.employerReturn], 
                        backgroundColor: ['#4f46e5', '#f43f5e'], 
                        borderWidth: 5, borderColor: '#ffffff', hoverOffset: 4
                    }] 
                },
                options: { cutout: '75%', plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Sarabun' } } } }
            });
        };

        const renderHeatmap = () => {
            const cont = document.getElementById('heatmapContainer'); 
            if(!cont) return;
            cont.innerHTML = '';
            
            const mths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const yrs = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort((a,b) => b-a); 
            const hm = {}; yrs.forEach(y => hm[y] = Array(12).fill(null));
            
            fullData.forEach((d, i) => {
                const y = d.sortDate.getFullYear(), m = d.sortDate.getMonth();
                const cur = d.empReturn + d.employerReturn;
                hm[y][m] = i > 0 ? cur - (fullData[i-1].empReturn + fullData[i-1].employerReturn) : cur;
            });

            let maxP = 0, maxL = 0;
            Object.values(hm).forEach(yA => yA.forEach(v => { if(v !== null) { if(v>0) maxP = Math.max(maxP,v); if(v<0) maxL = Math.min(maxL,v); } }));

            const hRow = document.createElement('div');
            hRow.className = 'grid gap-2 mb-2'; hRow.style.gridTemplateColumns = `minmax(50px, 0.5fr) repeat(12, 1fr) minmax(80px, 0.8fr)`;
            hRow.innerHTML = `<div class="col-span-1"></div>` + mths.map(m => `<div class="text-center text-[10px] font-extrabold text-slate-400 uppercase tracking-tighter">${m}</div>`).join('') + `<div class="text-center text-[10px] font-extrabold text-slate-900 uppercase">รวมรายปี</div>`;
            cont.appendChild(hRow);

            yrs.forEach(y => {
                const row = document.createElement('div'); row.className = 'grid gap-2 mb-2'; row.style.gridTemplateColumns = `minmax(50px, 0.5fr) repeat(12, 1fr) minmax(80px, 0.8fr)`;
                let html = `<div class="flex items-center text-sm font-extrabold text-slate-700 sticky left-0 bg-white/50 backdrop-blur-sm z-10">${y}</div>`;
                let yt = 0;
                hm[y].forEach(v => {
                    if(v === null) html += `<div class="heatmap-cell bg-slate-50 text-slate-300 border-none shadow-inner text-[9px]">-</div>`;
                    else {
                        yt += v;
                        const op = v>0 ? Math.max(0.4, v/maxP) : (v<0 ? Math.max(0.4, v/maxL) : 0);
                        const bg = v>0 ? `rgba(16, 185, 129, ${op})` : (v<0 ? `rgba(244, 63, 94, ${op})` : '#f8fafc');
                        const vt = Math.abs(v) >= 1000 ? (v/1000).toFixed(1) + 'k' : Math.round(v);
                        html += `<div class="heatmap-cell text-white shadow-sm hover:z-20" style="background:${bg};" title="${mths[hm[y].indexOf(v)]} ${y}: ${v.toLocaleString()} ฿">${vt}</div>`;
                    }
                });
                html += `<div class="flex items-center justify-center rounded-xl text-[10px] sm:text-xs font-black ${yt >=0 ? 'bg-indigo-600 text-white' : 'bg-rose-600 text-white'} shadow-lg border border-white/20">฿${(yt/1000).toFixed(1)}k</div>`;
                row.innerHTML = html; cont.appendChild(row);
            });
        };

        const renderTable = () => {
            const body = document.getElementById('dataTable'); body.innerHTML = '';
            [...filteredData].reverse().forEach((d, i, arr) => {
                const delta = i < arr.length-1 ? d.total - arr[i+1].total : 0;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-slate-900 whitespace-nowrap">${d.date}</td>
                    <td class="px-4 py-4 text-right text-slate-500 whitespace-nowrap">฿${(d.empAccum+d.employerAccum).toLocaleString()}</td>
                    <td class="px-4 py-4 text-right font-medium whitespace-nowrap ${d.empReturn+d.employerReturn >=0 ? 'text-emerald-600' : 'text-rose-600'}">฿${(d.empReturn+d.employerReturn).toLocaleString()}</td>
                    <td class="px-4 py-4 text-right whitespace-nowrap"><span class="px-2 py-1 rounded-lg text-[10px] font-bold ${delta >=0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">${delta >=0 ? '+' : ''}${delta.toLocaleString()}</span></td>
                    <td class="px-6 py-4 text-right font-bold text-slate-900 whitespace-nowrap">฿${d.total.toLocaleString()}</td>
                `;
                body.appendChild(tr);
            });
        };

        // --- SIMULATION LOGIC ---
        const renderSimulation = () => {
            if(!fullData.length) return;
            const last = fullData[fullData.length-1];
            const currentTotal = last.total;
            
            const rateYear = parseFloat(document.getElementById('simRate').value) / 100 || 0.05;
            const monthlyAdd = parseFloat(document.getElementById('simMonthly').value) || 0;
            
            // Formula: FV = PV(1+r)^n + PMT * [((1+r)^n - 1) / (r/12)] (Simplified annual compounding for PV, monthly for PMT usually better)
            // Let's use monthly compounding for accuracy:
            // r_month = rateYear / 12
            // n_months = years * 12
            // FV = PV * (1 + r_month)^n_months + PMT * (((1 + r_month)^n_months - 1) / r_month)

            const calcFV = (years) => {
                const rMonth = rateYear / 12;
                const nMonths = years * 12;
                // If rate is 0
                if(rMonth === 0) return currentTotal + (monthlyAdd * nMonths);
                
                const fvPV = currentTotal * Math.pow(1 + rMonth, nMonths);
                const fvPMT = monthlyAdd * ((Math.pow(1 + rMonth, nMonths) - 1) / rMonth);
                return fvPV + fvPMT;
            };

            const nf = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n);
            const nfShort = n => {
                if(n > 1000000) return (n/1000000).toFixed(2) + "M";
                if(n > 1000) return (n/1000).toFixed(1) + "k";
                return n;
            }

            const y3 = calcFV(3);
            const y5 = calcFV(5);
            const y10 = calcFV(10);

            document.getElementById('val3y').textContent = nf(y3);
            document.getElementById('gain3y').textContent = '+' + nfShort(y3 - currentTotal);
            
            document.getElementById('val5y').textContent = nf(y5);
            document.getElementById('gain5y').textContent = '+' + nfShort(y5 - currentTotal);

            document.getElementById('val10y').textContent = nf(y10);
            document.getElementById('gain10y').textContent = '+' + nfShort(y10 - currentTotal);

            // Simulation Chart
            const ctxS = document.getElementById('simChart').getContext('2d');
            if(simChart) simChart.destroy();
            simChart = new Chart(ctxS, {
                type: 'bar',
                data: {
                    labels: ['ปัจจุบัน', 'อีก 3 ปี', 'อีก 5 ปี', 'อีก 10 ปี'],
                    datasets: [{
                        label: 'มูลค่าคาดการณ์ (บาท)',
                        data: [currentTotal, y3, y5, y10],
                        backgroundColor: ['#cbd5e1', '#4f46e5', '#4338ca', '#312e81'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Sarabun' } } },
                    scales: {
                        y: { beginAtZero: false, ticks: { callback: function(value) { return value/1000000 + 'M'; } } },
                        x: { grid: { display: false } }
                    }
                }
            });
        };
    </script>
</body>
</html>
