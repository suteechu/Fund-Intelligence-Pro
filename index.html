<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fund Intelligence Pro - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@300;400;500;700&display=swap');
        
        :root { 
            --primary: #4f46e5; 
            --success: #10b981; 
            --danger: #f43f5e;
            --surface: #ffffff;
        }

        body { 
            font-family: 'Inter', 'Sarabun', sans-serif; 
            background: #fdfdfd; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .stat-card {
            background: var(--surface);
            @apply p-5 rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-500 ease-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -2px rgba(0, 0, 0, 0.02);
        }
        
        .stat-card:hover {
            @apply -translate-y-1.5;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            border-color: rgba(79, 70, 229, 0.1);
        }

        .chart-container { position: relative; height: 320px; width: 100%; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        .animate-fade-up {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 28px;
        }

        .heatmap-cell:hover {
            transform: scale(1.2) translateY(-2px);
            z-index: 10;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .goal-indicator {
            background: linear-gradient(90deg, #4f46e5 0%, #818cf8 100%);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="min-h-screen pb-12 bg-slate-50/30">

    <!-- Premium Navbar -->
    <nav class="sticky top-0 z-50 glass-nav no-print">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-11 h-11 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-200">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight text-slate-900 leading-none">Fund Intelligence</h1>
                    <p class="text-[10px] text-indigo-500 font-bold uppercase tracking-[0.2em] mt-1">Institutional Pro</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="togglePasteModal(true)" class="flex items-center gap-2 bg-slate-900 text-white px-5 py-2.5 rounded-2xl text-xs font-bold hover:bg-slate-800 transition-all active:scale-95 shadow-lg shadow-slate-200">
                    <i data-lucide="plus" class="w-4 h-4"></i> <span>ข้อมูลใหม่</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Empty State UI -->
        <div id="emptyState" class="py-32 text-center animate-fade-up">
            <div class="max-w-md mx-auto">
                <div class="relative inline-block mb-10">
                    <div class="absolute -inset-4 bg-indigo-100/50 rounded-[3rem] blur-2xl"></div>
                    <div class="relative w-24 h-24 bg-white border border-slate-100 text-indigo-600 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-xl">
                        <i data-lucide="pie-chart" class="w-10 h-10"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-3">ยินดีต้อนรับสู่ศูนย์วิเคราะห์พอร์ต</h2>
                <p class="text-slate-500 text-sm mb-10 leading-relaxed">วางข้อมูลจากไฟล์รายงานหรือคัดลอกจาก Excel <br>เพื่อเริ่มการวิเคราะห์เชิงลึกด้วยระบบอัจฉริยะ</p>
                <button onclick="togglePasteModal(true)" class="inline-flex items-center gap-3 bg-indigo-600 text-white px-10 py-4 rounded-[1.5rem] font-bold shadow-2xl shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 transition-all">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    วางข้อมูลเพื่อเริ่มต้น
                </button>
            </div>
        </div>

        <!-- Dashboard Analytics -->
        <div id="dashboardContent" class="hidden space-y-8 animate-fade-up">
            
            <!-- Quick Actions & Search -->
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 no-print">
                <div class="flex items-center gap-2 bg-white p-1.5 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto custom-scrollbar">
                    <button onclick="setFilter('all')" id="filter-all" class="px-5 py-2 rounded-xl text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-100">ภาพรวมทั้งหมด</button>
                    <div id="yearFilters" class="flex gap-1"></div>
                </div>
                <div class="flex items-center gap-4 bg-white px-5 py-2.5 rounded-2xl border border-slate-200 shadow-sm w-full md:w-auto">
                    <div class="flex items-center gap-2">
                        <i data-lucide="target" class="w-4 h-4 text-slate-400"></i>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">เป้าหมายพอร์ต</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-slate-400 font-bold mr-1 text-sm">฿</span>
                        <input type="number" id="goalInput" value="1000000" onchange="updateUI()" class="w-28 text-sm font-bold border-none focus:ring-0 p-0 text-slate-900" />
                    </div>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-5">
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                        <div id="totalReturnBadge" class="text-[9px] font-bold px-2 py-0.5 rounded-full"></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">สินทรัพย์รวม</p>
                    <h3 class="text-2xl font-bold text-slate-900 tracking-tight" id="totalValue">฿0</h3>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="p-2 bg-emerald-50 text-emerald-600 rounded-xl"><i data-lucide="trending-up" class="w-4 h-4"></i></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">กำไรสะสมทั้งหมด</p>
                    <h3 class="text-2xl font-bold text-slate-900 tracking-tight" id="totalProfit">฿0</h3>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="p-2 bg-amber-50 text-amber-600 rounded-xl"><i data-lucide="flag" class="w-4 h-4"></i></div>
                        <span class="text-[10px] font-bold text-amber-600" id="goalProgressPct">0%</span>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Progress to Goal</p>
                    <div class="mt-3 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="goalProgressBar" class="h-full goal-indicator transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="p-2 bg-slate-50 text-slate-600 rounded-xl"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ระยะเวลาลงทุน</p>
                    <h3 class="text-2xl font-bold text-slate-900 tracking-tight" id="dataCountVal">0 งวด</h3>
                </div>
            </div>

            <!-- Visual Analytics Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Growth Chart -->
                <div class="lg:col-span-2 bg-white p-7 rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h4 class="text-base font-bold text-slate-900">การเติบโตของสินทรัพย์</h4>
                            <p class="text-xs text-slate-400">เปรียบเทียบเงินต้นและผลกำไรสะสม</p>
                        </div>
                        <div class="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                            <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-indigo-600"></span> รวม</div>
                            <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> กำไร</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="mainChart"></canvas></div>
                </div>

                <!-- Portfolio Mix -->
                <div class="bg-white p-7 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col items-center justify-between">
                    <div class="w-full text-left mb-4">
                        <h4 class="text-base font-bold text-slate-900">สัดส่วนเงินทุน</h4>
                        <p class="text-xs text-slate-400">การกระจายตัวของเงินสะสม</p>
                    </div>
                    <div class="relative w-full max-w-[220px] aspect-square">
                        <canvas id="pieChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Wealth</span>
                            <span id="pieCenterVal" class="text-base font-bold text-slate-900">฿0</span>
                        </div>
                    </div>
                    <div class="w-full space-y-3 mt-6">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-indigo-600"></div>
                                <span class="text-xs font-medium text-slate-600">ส่วนพนักงาน</span>
                            </div>
                            <span id="empPct" class="text-xs font-bold text-slate-900">0%</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-rose-500"></div>
                                <span class="text-xs font-medium text-slate-600">ส่วนนายจ้าง</span>
                            </div>
                            <span id="employerPct" class="text-xs font-bold text-slate-900">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap View -->
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h4 class="text-base font-bold text-slate-900">Monthly Profit Heatmap (฿)</h4>
                        <p class="text-xs text-slate-400">ผลตอบแทนสุทธิแยกตามเดือนและปี</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                             <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded bg-rose-500 opacity-80"></span> ขาดทุน</div>
                             <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded bg-emerald-500 opacity-80"></span> กำไร</div>
                        </div>
                        <div class="h-8 w-px bg-slate-100 hidden sm:block"></div>
                        <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-xl uppercase tracking-wider">Unit: 1,000 THB</span>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar pb-2">
                    <div id="heatmapContainer" class="min-w-[850px] space-y-2"></div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-slate-50 flex items-center justify-between bg-white">
                    <h4 class="text-sm font-bold text-slate-900">ประวัติรายการรายงวด</h4>
                    <span id="dataCount" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1 rounded-xl font-bold">0 งวด</span>
                </div>
                <div class="overflow-x-auto custom-scrollbar max-h-[450px]">
                    <table class="w-full text-xs text-left border-collapse">
                        <thead class="sticky top-0 bg-slate-50/95 backdrop-blur-md z-10 border-b border-slate-100 font-bold text-slate-500 uppercase tracking-widest">
                            <tr>
                                <th class="px-8 py-5">งวดวันที่</th>
                                <th class="px-6 py-5 text-right">เงินต้นสะสม</th>
                                <th class="px-6 py-5 text-right">กำไรสะสม</th>
                                <th class="px-6 py-5 text-right">การเติบโต</th>
                                <th class="px-8 py-5 text-right">มูลค่าสุทธิ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Unified Modal System -->
    <div id="pasteModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden animate-fade-up">
            <div class="p-8 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white text-indigo-600 rounded-2xl flex items-center justify-center shadow-lg"><i data-lucide="clipboard-copy" class="w-6 h-6"></i></div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">วางข้อมูลตาราง</h3>
                        <p class="text-xs text-slate-400 font-medium">คัดลอกจาก Excel หรือ Web Portal</p>
                    </div>
                </div>
                <button onclick="togglePasteModal(false)" class="p-3 hover:bg-white hover:shadow-md rounded-2xl transition-all"><i data-lucide="x" class="w-6 h-6 text-slate-300"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100/50">
                    <p class="text-[11px] font-medium text-indigo-600 leading-relaxed">
                        <span class="font-bold mr-1 italic">Tip:</span> 
                        ระบบจะตรวจจับ "งวดวันที่" และ "ตัวเลขยอดเงิน" ให้โดยอัตโนมัติ คุณสามารถก๊อปปี้ข้อมูลที่มีข้อความปนมาด้วยได้เลยครับ
                    </p>
                </div>
                <textarea id="pasteArea" class="w-full h-80 p-6 rounded-[2rem] bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 focus:bg-white outline-none font-mono text-[11px] resize-none custom-scrollbar transition-all shadow-inner" placeholder="Paste your data table here..."></textarea>
                <div class="flex gap-4">
                    <button onclick="smartProcess()" class="flex-1 bg-indigo-600 text-white py-5 rounded-[1.5rem] font-bold shadow-xl shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">ประมวลผลข้อมูล</button>
                    <button onclick="togglePasteModal(false)" class="flex-1 bg-slate-100 text-slate-600 py-5 rounded-[1.5rem] font-bold hover:bg-slate-200 transition-all">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Micro Loader -->
    <div id="loader" class="fixed inset-0 bg-white/90 backdrop-blur-xl z-[150] hidden flex flex-col items-center justify-center">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <p class="text-slate-900 font-bold tracking-widest animate-pulse">ANALYZING PORTFOLIO</p>
    </div>

    <script>
        lucide.createIcons();
        
        let fullData = [], filteredData = [], mainChart, pieChart;

        const togglePasteModal = s => {
            const modal = document.getElementById('pasteModal');
            if (modal) modal.classList.toggle('hidden', !s);
            if(s) { 
                const area = document.getElementById('pasteArea');
                if (area) { area.value = ''; area.focus(); }
            }
        };

        const parseNum = v => v ? parseFloat(v.replace(/,/g, '')) || 0 : 0;

        const getDateValue = s => {
            if (!s) return new Date();
            const p = s.split(/[./-]/);
            if(p.length === 3) { 
                let y = parseInt(p[2]); 
                // Handle 2-digit years
                if (y < 100) y += 2000;
                // Handle Buddhist Era
                if (y > 2400) y -= 543; 
                return new Date(y, parseInt(p[1])-1, parseInt(p[0])); 
            }
            return new Date(s);
        };

        const smartProcess = () => {
            const area = document.getElementById('pasteArea');
            if (!area) return;
            const text = area.value.trim();
            if(!text) return;
            
            const res = [];
            document.getElementById('loader').classList.remove('hidden');

            setTimeout(() => {
                text.split('\n').forEach(line => {
                    const dateMatch = line.match(/(\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})/);
                    if(dateMatch) {
                        const dStr = dateMatch[1];
                        // Match numbers with optional commas and decimals
                        const nums = line.substring(line.indexOf(dStr) + dStr.length).match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/g) || [];
                        if(nums.length >= 5) {
                            res.push({ 
                                date: dStr, 
                                empAccum: parseNum(nums[0]), 
                                empReturn: parseNum(nums[1]), 
                                employerAccum: parseNum(nums[2]), 
                                employerReturn: parseNum(nums[3]), 
                                total: parseNum(nums[4]), 
                                sortDate: getDateValue(dStr) 
                            });
                        }
                    }
                });

                if(!res.length) {
                    document.getElementById('loader').classList.add('hidden');
                    return alert("ไม่สามารถอ่านข้อมูลได้ กรุณาลองใหม่อีกครั้ง");
                }

                fullData = res.sort((a,b) => a.sortDate - b.sortDate);
                genYearFilters();
                setFilter('all');
                
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
                togglePasteModal(false);
            }, 600);
        };

        const genYearFilters = () => {
            const cont = document.getElementById('yearFilters'); 
            if (!cont) return;
            cont.innerHTML = '';
            const years = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort();
            
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.className = "px-5 py-2 rounded-xl text-xs font-bold transition-all text-slate-500 hover:bg-slate-50";
                btn.textContent = y; btn.id = `filter-${y}`; btn.onclick = () => setFilter(y);
                cont.appendChild(btn);
            });
        };

        const setFilter = y => {
            document.querySelectorAll('#yearFilters button, #filter-all').forEach(b => { 
                b.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-100'); 
                b.classList.add('text-slate-500'); 
            });
            const act = document.getElementById(y === 'all' ? 'filter-all' : `filter-${y}`);
            if(act) { 
                act.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-100'); 
                act.classList.remove('text-slate-500'); 
            }
            filteredData = y === 'all' ? fullData : fullData.filter(d => d.sortDate.getFullYear() === parseInt(y));
            updateUI();
        };

        const updateUI = () => {
            if (!filteredData.length) return;
            const last = filteredData[filteredData.length-1], first = filteredData[0];
            const nf = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n);
            
            // Stats
            document.getElementById('totalValue').textContent = nf(last.total);
            const profit = last.empReturn + last.employerReturn;
            document.getElementById('totalProfit').textContent = nf(profit);
            const inv = Math.max(last.empAccum + last.employerAccum, 1);
            document.getElementById('dataCountVal').textContent = `${filteredData.length} งวด`;

            // Goal
            const goal = parseFloat(document.getElementById('goalInput').value) || 1;
            const progress = (last.total / goal) * 100;
            document.getElementById('goalProgressPct').textContent = progress.toFixed(1) + '%';
            document.getElementById('goalProgressBar').style.width = Math.min(progress, 100) + '%';
            
            // Return Percentage
            const pct = (profit / inv) * 100;
            const rb = document.getElementById('totalReturnBadge');
            rb.innerHTML = `<i data-lucide="${pct>=0?'trending-up':'trending-down'}" class="w-3 h-3"></i> ${pct>=0?'+':''}${pct.toFixed(2)}%`;
            rb.className = `text-[10px] font-bold px-2 py-1 rounded-lg ${pct>=0?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'}`;
            
            // Pie Metrics
            document.getElementById('pieCenterVal').textContent = nf(last.total).replace('฿', '');
            const ePctValue = ((last.empAccum+last.empReturn)/last.total)*100;
            document.getElementById('empPct').textContent = ePctValue.toFixed(0) + '%';
            document.getElementById('employerPct').textContent = (100-ePctValue).toFixed(0) + '%';

            document.getElementById('dataCount').textContent = `${filteredData.length} รายการ`;

            renderCharts(); renderHeatmap(); renderTable(); lucide.createIcons();
        };

        const renderCharts = () => {
            const ctxL = document.getElementById('mainChart').getContext('2d');
            if(mainChart) mainChart.destroy();
            
            // Shadow Gradient
            const grad = ctxL.createLinearGradient(0, 0, 0, 400);
            grad.addColorStop(0, 'rgba(79, 70, 229, 0.1)');
            grad.addColorStop(1, 'rgba(79, 70, 229, 0)');

            mainChart = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: filteredData.map(d=>d.date),
                    datasets: [
                        { 
                            label: 'สินทรัพย์รวม', 
                            data: filteredData.map(d=>d.total), 
                            borderColor: '#4f46e5', 
                            borderWidth: 4, 
                            fill: true, 
                            backgroundColor: grad, 
                            tension: 0.4, 
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#4f46e5',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        { 
                            label: 'กำไรสะสม', 
                            data: filteredData.map(d=>d.empReturn+d.employerReturn), 
                            borderColor: '#10b981', 
                            borderWidth: 2.5, 
                            borderDash: [5, 5],
                            tension: 0.4, 
                            pointRadius: 0 
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleFont: { family: 'Sarabun', size: 12 },
                            bodyFont: { family: 'Sarabun', size: 11 },
                            padding: 12,
                            cornerRadius: 12,
                            displayColors: false
                        }
                    }, 
                    scales: { 
                        y: { ticks: { font: { size: 10, weight: 600 } }, grid: { color: '#f8fafc' } }, 
                        x: { ticks: { font: { size: 10 }, maxRotation: 0 }, grid: { display: false } } 
                    } 
                }
            });
            
            const ctxP = document.getElementById('pieChart').getContext('2d');
            if(pieChart) pieChart.destroy();
            const last = filteredData[filteredData.length-1];
            pieChart = new Chart(ctxP, {
                type: 'doughnut',
                data: { 
                    labels: ['พนักงาน', 'นายจ้าง'], 
                    datasets: [{ 
                        data: [last.empAccum+last.empReturn, last.employerAccum+last.employerReturn], 
                        backgroundColor: ['#4f46e5', '#f43f5e'], 
                        borderWidth: 6, 
                        borderColor: '#ffffff',
                        hoverOffset: 10
                    }] 
                },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });
        };

        const renderHeatmap = () => {
            const cont = document.getElementById('heatmapContainer'); 
            if (!cont) return;
            cont.innerHTML = '';
            
            const mths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const yrs = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort();
            const hm = {}; yrs.forEach(y => hm[y] = Array(12).fill(null));
            
            fullData.forEach((d, i) => {
                const y = d.sortDate.getFullYear(), m = d.sortDate.getMonth();
                const cur = d.empReturn + d.employerReturn;
                hm[y][m] = i > 0 ? cur - (fullData[i-1].empReturn + fullData[i-1].employerReturn) : cur;
            });

            let maxP = 0, maxL = 0;
            Object.values(hm).forEach(yA => yA.forEach(v => { if(v>0) maxP = Math.max(maxP,v); if(v<0) maxL = Math.min(maxL,v); }));

            const hRow = document.createElement('div');
            hRow.className = 'grid gap-2 mb-4'; hRow.style.gridTemplateColumns = `minmax(60px, 1fr) repeat(12, 1fr) minmax(80px, 1fr)`;
            hRow.innerHTML = `<div class="col-span-1"></div>` + mths.map(m => `<div class="text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">${m}</div>`).join('') + `<div class="text-center text-[10px] font-bold text-slate-900 uppercase tracking-widest">Total</div>`;
            cont.appendChild(hRow);

            yrs.forEach(y => {
                const row = document.createElement('div'); row.className = 'grid gap-2'; row.style.gridTemplateColumns = `minmax(60px, 1fr) repeat(12, 1fr) minmax(80px, 1fr)`;
                let html = `<div class="flex items-center text-xs font-bold text-slate-900">${y}</div>`;
                let yearlyTotal = 0;
                hm[y].forEach(v => {
                    if(v === null) html += `<div class="heatmap-cell bg-slate-50 text-slate-200">-</div>`;
                    else {
                        yearlyTotal += v;
                        const op = v>0 ? Math.max(0.15, v/maxP) : (v<0 ? Math.max(0.15, v/maxL) : 0);
                        const bg = v>0 ? `rgba(16, 185, 129, ${op})` : (v<0 ? `rgba(244, 63, 94, ${op})` : '#f8fafc');
                        const valText = Math.abs(v) >= 1000 ? (v/1000).toFixed(1) + 'k' : Math.round(v);
                        html += `<div class="heatmap-cell text-white shadow-sm" style="background:${bg}" title="${v.toLocaleString()} ฿">${valText}</div>`;
                    }
                });
                html += `<div class="heatmap-year-total ${yearlyTotal >=0 ? 'bg-indigo-600' : 'bg-rose-600'} shadow-lg shadow-indigo-100">฿${(yearlyTotal/1000).toFixed(1)}k</div>`;
                row.innerHTML = html; cont.appendChild(row);
            });
        };

        const renderTable = () => {
            const body = document.getElementById('dataTable'); 
            body.innerHTML = '';
            [...filteredData].reverse().forEach((d, i, arr) => {
                const delta = i < arr.length-1 ? d.total - arr[i+1].total : 0;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/70 transition-colors group";
                tr.innerHTML = `
                    <td class="px-8 py-4 font-bold text-slate-900">${d.date}</td>
                    <td class="px-6 py-4 text-right text-slate-500">฿${(d.empAccum+d.employerAccum).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-medium ${d.empReturn+d.employerReturn >=0 ? 'text-emerald-600' : 'text-rose-600'}">฿${(d.empReturn+d.employerReturn).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right"><span class="px-2 py-1 rounded-lg text-[10px] font-bold ${delta >=0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} group-hover:shadow-sm">${delta >=0 ? '+' : ''}${delta.toLocaleString()}</span></td>
                    <td class="px-8 py-4 text-right font-bold text-slate-900">฿${d.total.toLocaleString()}</td>
                `;
                body.appendChild(tr);
            });
        };
    </script>
</body>
</html>
