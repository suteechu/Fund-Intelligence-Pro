<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fund Intelligence Pro - Premium Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@300;400;500;700&display=swap');
        
        :root { 
            --primary: #4f46e5; 
            --success: #10b981; 
            --danger: #f43f5e;
            --surface: #ffffff;
        }

        body { 
            font-family: 'Inter', 'Sarabun', sans-serif; 
            background: #f8fafc; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        }

        .stat-card {
            background: var(--surface);
            @apply p-5 rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-300;
        }
        
        .stat-card:hover {
            @apply -translate-y-1 shadow-xl shadow-indigo-100/30;
            border-color: rgba(79, 70, 229, 0.2);
        }

        .chart-container { position: relative; height: 320px; width: 100%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .animate-fade-up {
            animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 700;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 26px;
        }

        .heatmap-cell:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .goal-indicator {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
        }

        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn-premium {
            @apply bg-indigo-600 text-white px-5 py-2.5 rounded-2xl text-xs font-bold hover:bg-indigo-700 transition-all active:scale-95 shadow-lg shadow-indigo-100;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-nav no-print">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                    <i data-lucide="bar-chart-big" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-base font-bold text-slate-900 leading-none">Fund Intelligence</h1>
                    <p class="text-[9px] text-indigo-500 font-bold uppercase tracking-[0.1em] mt-1">Institutional Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="togglePasteModal(true)" class="btn-premium flex items-center gap-2">
                    <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
                    <span>วางข้อมูล</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Empty State -->
        <div id="emptyState" class="py-24 text-center animate-fade-up">
            <div class="max-w-md mx-auto">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="layout-dashboard" class="w-10 h-10"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">เริ่มวิเคราะห์พอร์ตของคุณ</h2>
                <p class="text-slate-500 text-sm mb-10 leading-relaxed">คัดลอกตารางจาก Excel หรือระบบพอร์ทัลมาวางเพื่อดูแนวโน้มการเติบโตและสุขภาพการลงทุนได้ทันที</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="togglePasteModal(true)" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-3">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                        วางข้อมูลเพื่อเริ่มต้น
                    </button>
                    <button onclick="loadSampleData()" class="bg-white border border-slate-200 text-slate-600 px-8 py-4 rounded-2xl font-bold hover:bg-slate-50 transition-all">
                        ดูข้อมูลตัวอย่าง
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-6 animate-fade-up">
            
            <!-- Filter Bar -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-2 bg-white p-1 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto custom-scrollbar w-full sm:w-auto">
                    <button onclick="setFilter('all')" id="filter-all" class="px-4 py-2 rounded-xl text-xs font-bold transition-all bg-indigo-600 text-white">ทั้งหมด</button>
                    <div id="yearFilters" class="flex gap-1"></div>
                </div>
                <div class="bg-white px-4 py-2 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4 w-full sm:w-auto justify-between">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="target" class="w-4 h-4"></i>
                        <span class="text-[10px] font-bold uppercase">เป้าหมาย (฿)</span>
                    </div>
                    <input type="number" id="goalInput" value="1000000" onchange="updateUI()" class="w-24 text-right font-bold focus:ring-0 border-none p-0 text-indigo-600" />
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-3">
                        <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                        <span id="totalReturnBadge" class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500"></span>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">มูลค่ารวม</p>
                    <h3 class="text-xl font-bold text-slate-900" id="totalValue">฿0</h3>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-3">
                        <div class="p-2 bg-emerald-50 text-emerald-600 rounded-xl"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">กำไรสะสม</p>
                    <h3 class="text-xl font-bold text-slate-900" id="totalProfit">฿0</h3>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-3">
                        <div class="p-2 bg-amber-50 text-amber-600 rounded-xl"><i data-lucide="flag" class="w-4 h-4"></i></div>
                        <span id="goalProgressPct" class="text-[10px] font-bold text-amber-600">0%</span>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ความคืบหน้า</p>
                    <div class="mt-2.5 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div id="goalProgressBar" class="h-full goal-indicator transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-3">
                        <div class="p-2 bg-slate-50 text-slate-600 rounded-xl"><i data-lucide="calendar-check" class="w-4 h-4"></i></div>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">งวดลงทุน</p>
                    <h3 class="text-xl font-bold text-slate-900" id="dataCountVal">0 งวด</h3>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                    <h4 class="text-sm font-bold mb-6 flex items-center gap-2"><i data-lucide="area-chart" class="w-4 h-4 text-indigo-600"></i> แนวโน้มการเติบโต</h4>
                    <div class="chart-container"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col items-center">
                    <h4 class="text-sm font-bold mb-6 w-full"><i data-lucide="pie-chart" class="w-4 h-4 text-indigo-600 inline mr-1"></i> สัดส่วนเงินทุน</h4>
                    <div class="relative w-full max-w-[200px] aspect-square my-auto">
                        <canvas id="pieChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-[8px] text-slate-400 font-bold uppercase tracking-wider">Total</span>
                            <span id="pieCenterVal" class="text-sm font-bold text-slate-900">฿0</span>
                        </div>
                    </div>
                    <div class="w-full grid grid-cols-2 gap-2 mt-6">
                        <div class="p-3 bg-indigo-50/50 rounded-2xl text-center">
                            <p class="text-[9px] font-bold text-indigo-600 uppercase">พนง.</p>
                            <p id="empPct" class="text-xs font-bold">0%</p>
                        </div>
                        <div class="p-3 bg-rose-50/50 rounded-2xl text-center">
                            <p class="text-[9px] font-bold text-rose-600 uppercase">นจ.</p>
                            <p id="employerPct" class="text-xs font-bold">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="flex items-center justify-between mb-6">
                    <h4 class="text-sm font-bold flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-indigo-600"></i> ผลตอบแทนรายเดือน (K = 1,000 THB)</h4>
                    <div class="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                         <div class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-rose-500"></span> ขาดทุน</div>
                         <div class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-emerald-500"></span> กำไร</div>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <div id="heatmapContainer" class="min-w-[800px] space-y-2 pb-2"></div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-slate-50 flex items-center justify-between">
                    <h4 class="text-sm font-bold">ประวัติรายการรายงวด</h4>
                    <span id="dataCount" class="text-[10px] bg-slate-100 px-3 py-1 rounded-xl font-bold">0 งวด</span>
                </div>
                <div class="overflow-x-auto custom-scrollbar max-h-[400px]">
                    <table class="w-full text-xs text-left border-collapse">
                        <thead class="sticky top-0 bg-slate-50/90 backdrop-blur-sm z-10 border-b border-slate-100 font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="px-8 py-4">งวดวันที่</th>
                                <th class="px-6 py-4 text-right">เงินต้นสะสม</th>
                                <th class="px-6 py-4 text-right">กำไรสะสม</th>
                                <th class="px-6 py-4 text-right">การเติบโต</th>
                                <th class="px-8 py-4 text-right">มูลค่าสุทธิ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="pasteModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-fade-up">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-50 text-indigo-600 rounded-xl"><i data-lucide="clipboard-list" class="w-5 h-5"></i></div>
                    <h3 class="font-bold text-slate-900">วางข้อมูลตาราง</h3>
                </div>
                <button onclick="togglePasteModal(false)" class="p-2 hover:bg-slate-100 rounded-xl"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <textarea id="pasteArea" class="w-full h-80 p-4 rounded-[1.5rem] bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 outline-none font-mono text-[10px] resize-none" placeholder="คัดลอกจาก Excel แล้ววางที่นี่..."></textarea>
                <div class="flex gap-3">
                    <button onclick="smartProcess()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition-all">เริ่มวิเคราะห์</button>
                    <button onclick="togglePasteModal(false)" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold transition-all">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let fullData = [], filteredData = [], mainChart, pieChart;

        const togglePasteModal = s => {
            const m = document.getElementById('pasteModal');
            if(m) m.classList.toggle('hidden', !s);
            if(s) { const a = document.getElementById('pasteArea'); if(a){ a.value=''; a.focus(); } }
        };

        const parseNum = v => v ? parseFloat(v.replace(/,/g, '')) || 0 : 0;

        const getDateValue = s => {
            if (!s) return new Date();
            const p = s.split(/[./-]/);
            if(p.length === 3) { 
                let y = parseInt(p[2]); 
                if (y < 100) y += 2000;
                if (y > 2400) y -= 543; 
                return new Date(y, parseInt(p[1])-1, parseInt(p[0])); 
            }
            return new Date(s);
        };

        const loadSampleData = () => {
            const sample = `31.12.2025669,584.60113,545.81538,941.1098,705.061,420,776.57
30.11.2025664,058.60110,960.85534,520.3096,599.651,406,139.40
31.10.2025658,532.60112,183.99530,099.5097,596.291,398,412.38
30.09.2025653,006.60106,883.68525,678.7093,276.271,378,845.25
31.08.2025647,480.6094,979.20521,257.9083,576.931,347,294.63
31.07.2025641,954.6086,240.75516,837.1076,457.561,321,490.01
31.12.2024603,272.6060,277.89485,891.5055,299.571,204,741.56
30.11.2024597,911.6066,450.20481,602.7060,337.611,206,302.11`;
            document.getElementById('pasteArea').value = sample;
            smartProcess();
        };

        const smartProcess = () => {
            const area = document.getElementById('pasteArea');
            if(!area) return;
            const text = area.value.trim();
            if(!text) return;
            
            const res = [];
            text.split('\n').forEach(line => {
                const dateMatch = line.match(/(\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})/);
                if(dateMatch) {
                    const dStr = dateMatch[1];
                    const nums = line.substring(line.indexOf(dStr) + dStr.length).match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/g) || [];
                    if(nums.length >= 5) {
                        res.push({ 
                            date: dStr, 
                            empAccum: parseNum(nums[0]), 
                            empReturn: parseNum(nums[1]), 
                            employerAccum: parseNum(nums[2]), 
                            employerReturn: parseNum(nums[3]), 
                            total: parseNum(nums[4]), 
                            sortDate: getDateValue(dStr) 
                        });
                    }
                }
            });

            if(!res.length) return alert("รูปแบบข้อมูลไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง");

            fullData = res.sort((a,b) => a.sortDate - b.sortDate);
            genYearFilters();
            setFilter('all');
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            togglePasteModal(false);
        };

        const genYearFilters = () => {
            const cont = document.getElementById('yearFilters'); 
            if(!cont) return;
            cont.innerHTML = '';
            const years = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort();
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.className = "px-4 py-2 rounded-xl text-xs font-bold transition-all text-slate-500 hover:bg-slate-50";
                btn.textContent = y; btn.id = `filter-${y}`; btn.onclick = () => setFilter(y);
                cont.appendChild(btn);
            });
        };

        const setFilter = y => {
            document.querySelectorAll('#yearFilters button, #filter-all').forEach(b => { 
                b.classList.remove('bg-indigo-600', 'text-white'); 
                b.classList.add('text-slate-500'); 
            });
            const act = document.getElementById(y === 'all' ? 'filter-all' : `filter-${y}`);
            if(act) { act.classList.add('bg-indigo-600', 'text-white'); act.classList.remove('text-slate-500'); }
            filteredData = y === 'all' ? fullData : fullData.filter(d => d.sortDate.getFullYear() === parseInt(y));
            updateUI();
        };

        const updateUI = () => {
            if(!filteredData.length) return;
            const last = filteredData[filteredData.length-1];
            const first = filteredData[0];
            const nf = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n);
            
            document.getElementById('totalValue').textContent = nf(last.total);
            const profit = last.empReturn + last.employerReturn;
            document.getElementById('totalProfit').textContent = nf(profit);
            const inv = Math.max(last.empAccum + last.employerAccum, 1);
            document.getElementById('dataCountVal').textContent = `${filteredData.length} งวด`;

            const goal = parseFloat(document.getElementById('goalInput').value) || 1;
            const progress = (last.total / goal) * 100;
            document.getElementById('goalProgressPct').textContent = progress.toFixed(1) + '%';
            document.getElementById('goalProgressBar').style.width = Math.min(progress, 100) + '%';
            
            const pct = (profit / inv) * 100;
            const rb = document.getElementById('totalReturnBadge');
            rb.innerHTML = `<i data-lucide="${pct>=0?'trending-up':'trending-down'}" class="w-3 h-3"></i> ${pct>=0?'+':''}${pct.toFixed(2)}%`;
            rb.className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${pct>=0?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'}`;
            
            document.getElementById('pieCenterVal').textContent = nf(last.total).replace('฿', '');
            const ePctValue = ((last.empAccum+last.empReturn)/last.total)*100;
            document.getElementById('empPct').textContent = ePctValue.toFixed(0) + '%';
            document.getElementById('employerPct').textContent = (100-ePctValue).toFixed(0) + '%';
            document.getElementById('dataCount').textContent = `${filteredData.length} งวด`;

            renderCharts(last); renderHeatmap(); renderTable(); lucide.createIcons();
        };

        const renderCharts = (last) => {
            const ctxL = document.getElementById('mainChart').getContext('2d');
            if(mainChart) mainChart.destroy();
            
            const g = ctxL.createLinearGradient(0, 0, 0, 400);
            g.addColorStop(0, 'rgba(79, 70, 229, 0.15)');
            g.addColorStop(1, 'rgba(79, 70, 229, 0)');

            mainChart = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: filteredData.map(d=>d.date),
                    datasets: [
                        { label: 'สินทรัพย์รวม', data: filteredData.map(d=>d.total), borderColor: '#4f46e5', borderWidth: 3, fill: true, backgroundColor: g, tension: 0.4, pointRadius: 0 },
                        { label: 'กำไรสะสม', data: filteredData.map(d=>d.empReturn+d.employerReturn), borderColor: '#10b981', borderWidth: 2, borderDash: [5,5], tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Sarabun' }, titleFont: { family: 'Sarabun' } } },
                    scales: { y: { ticks: { font: { size: 9 } }, grid: { borderDash: [5,5] } }, x: { ticks: { font: { size: 9 }, maxRotation: 0 }, grid: { display: false } } }
                }
            });
            
            const ctxP = document.getElementById('pieChart').getContext('2d');
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctxP, {
                type: 'doughnut',
                data: { 
                    labels: ['พนักงาน', 'นายจ้าง'], 
                    datasets: [{ 
                        data: [last.empAccum+last.empReturn, last.employerAccum+last.employerReturn], 
                        backgroundColor: ['#4f46e5', '#f43f5e'], 
                        borderWidth: 6, borderColor: '#ffffff'
                    }] 
                },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });
        };

        const renderHeatmap = () => {
            const cont = document.getElementById('heatmapContainer'); 
            if(!cont) return;
            cont.innerHTML = '';
            
            const mths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const yrs = [...new Set(fullData.map(d => d.sortDate.getFullYear()))].sort();
            const hm = {}; yrs.forEach(y => hm[y] = Array(12).fill(null));
            
            fullData.forEach((d, i) => {
                const y = d.sortDate.getFullYear(), m = d.sortDate.getMonth();
                const cur = d.empReturn + d.employerReturn;
                hm[y][m] = i > 0 ? cur - (fullData[i-1].empReturn + fullData[i-1].employerReturn) : cur;
            });

            let maxP = 0, maxL = 0;
            Object.values(hm).forEach(yA => yA.forEach(v => { if(v>0) maxP = Math.max(maxP,v); if(v<0) maxL = Math.min(maxL,v); }));

            const hRow = document.createElement('div');
            hRow.className = 'grid gap-2 mb-2'; hRow.style.gridTemplateColumns = `minmax(50px, 1fr) repeat(12, 1fr) minmax(80px, 1fr)`;
            hRow.innerHTML = `<div class="col-span-1"></div>` + mths.map(m => `<div class="text-center text-[9px] font-bold text-slate-400">${m}</div>`).join('') + `<div class="text-center text-[9px] font-bold text-slate-900">Total</div>`;
            cont.appendChild(hRow);

            yrs.forEach(y => {
                const row = document.createElement('div'); row.className = 'grid gap-2'; row.style.gridTemplateColumns = `minmax(50px, 1fr) repeat(12, 1fr) minmax(80px, 1fr)`;
                let html = `<div class="flex items-center text-xs font-bold text-slate-500">${y}</div>`;
                let yt = 0;
                hm[y].forEach(v => {
                    if(v === null) html += `<div class="heatmap-cell bg-slate-50 text-slate-200">-</div>`;
                    else {
                        yt += v;
                        const op = v>0 ? Math.max(0.2, v/maxP) : (v<0 ? Math.max(0.2, v/maxL) : 0);
                        const bg = v>0 ? `rgba(16, 185, 129, ${op})` : (v<0 ? `rgba(244, 63, 94, ${op})` : '#f8fafc');
                        const vt = Math.abs(v) >= 1000 ? (v/1000).toFixed(1) + 'k' : Math.round(v);
                        html += `<div class="heatmap-cell text-white shadow-sm" style="background:${bg}" title="${v.toLocaleString()} ฿">${vt}</div>`;
                    }
                });
                html += `<div class="flex items-center justify-center rounded-lg text-[10px] font-bold ${yt >=0 ? 'bg-indigo-600 text-white' : 'bg-rose-600 text-white'} shadow-sm">฿${(yt/1000).toFixed(1)}k</div>`;
                row.innerHTML = html; cont.appendChild(row);
            });
        };

        const renderTable = () => {
            const body = document.getElementById('dataTable'); body.innerHTML = '';
            [...filteredData].reverse().forEach((d, i, arr) => {
                const delta = i < arr.length-1 ? d.total - arr[i+1].total : 0;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-8 py-4 font-bold text-slate-900">${d.date}</td>
                    <td class="px-6 py-4 text-right text-slate-500">฿${(d.empAccum+d.employerAccum).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-medium ${d.empReturn+d.employerReturn >=0 ? 'text-emerald-600' : 'text-rose-600'}">฿${(d.empReturn+d.employerReturn).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right"><span class="px-2 py-1 rounded-lg text-[10px] font-bold ${delta >=0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">${delta >=0 ? '+' : ''}${delta.toLocaleString()}</span></td>
                    <td class="px-8 py-4 text-right font-bold text-slate-900">฿${d.total.toLocaleString()}</td>
                `;
                body.appendChild(tr);
            });
        };
    </script>
</body>
</html>
